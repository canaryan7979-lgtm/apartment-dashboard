<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse (CSV Parsing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .table-container { max-height: 500px; overflow-y: auto; }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a; /* ë³€ê²½: green-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-slate-500 mt-1">ìµœì‹  ì•„íŒŒíŠ¸ ê±°ë˜ í˜„í™©ì„ ë¶„ì„í•˜ê³  ì‹œê°í™”í•©ë‹ˆë‹¤.</p>
            </div>
            <!-- ë³€ê²½: í•„í„° ë“œë¡­ë‹¤ìš´ê³¼ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ í•¨ê»˜ ë°°ì¹˜ -->
            <div class="flex flex-col sm:flex-row gap-3 items-center">
                <select id="dong-filter" onchange="applyFilter()" class="bg-white border border-slate-300 text-slate-700 py-2 px-4 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 font-medium">
                    <option value="ì „ì²´">ì „ì²´ ë™ë„¤</option>
                </select>
                <button onclick="fetchData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition shadow-sm font-medium whitespace-nowrap">
                    ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
        </header>

        <!-- Loading Overlay -->
        <div id="loading" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center hidden">
            <div class="flex flex-col items-center">
                <div class="loader mb-4"></div>
                <p class="text-slate-600 font-medium">ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- ë³€ê²½: ì´ˆë¡ìƒ‰ í†¤ìœ¼ë¡œ ë³´ë” ë° ìˆ«ì ìƒ‰ìƒ í†µì¼, ì´ëª¨ì§€ ì¶”ê°€ -->
            <div class="card p-6 border-l-4 border-green-400">
                <p class="text-sm text-slate-500 font-medium">ğŸ  ì „ì²´ ê±°ë˜ ê±´ìˆ˜</p>
                <h3 id="stat-total" class="text-2xl font-bold text-green-700 mt-1">-</h3>
            </div>
            <div class="card p-6 border-l-4 border-green-500">
                <p class="text-sm text-slate-500 font-medium">ğŸ’° í‰ê·  ê±°ë˜ê°€ê²©</p>
                <h3 id="stat-avg" class="text-2xl font-bold text-green-700 mt-1">-</h3>
            </div>
            <div class="card p-6 border-l-4 border-green-600">
                <p class="text-sm text-slate-500 font-medium">ğŸ“ˆ ìµœê³  ê±°ë˜ê°€ê²©</p>
                <h3 id="stat-max" class="text-2xl font-bold text-green-700 mt-1">-</h3>
            </div>
            <div class="card p-6 border-l-4 border-green-700">
                <p class="text-sm text-slate-500 font-medium">ğŸ“‰ ìµœì € ê±°ë˜ê°€ê²©</p>
                <h3 id="stat-min" class="text-2xl font-bold text-green-700 mt-1">-</h3>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Chart Container (Takes 2 columns) -->
            <div class="card p-6 lg:col-span-2">
                <h2 class="text-xl font-bold text-slate-800 mb-6">ì›”ë³„ í‰ê·  ê±°ë˜ê°€ê²© ì¶”ì´ (ë§Œì›)</h2>
                <div class="h-80 relative">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- Top 5 Container (NEW) -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-6">ğŸ† ìš°ë¦¬ ë™ë„¤ ë¹„ì‹¼ ì•„íŒŒíŠ¸ TOP 5</h2>
                <div class="space-y-3" id="top5-container">
                    <!-- Top 5 list will be added here via JS -->
                </div>
            </div>
        </div>

        <!-- Table Container (Full Width) -->
        <div class="card p-6 mb-8">
            <h2 class="text-xl font-bold text-slate-800 mb-6">ìµœì‹  ê±°ë˜ ëª©ë¡</h2>
            <div class="table-container border rounded-lg">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs uppercase bg-slate-50 sticky top-0 text-slate-700 font-semibold border-b">
                        <tr>
                            <th class="px-4 py-3">ê±°ë˜ì¼ì</th>
                            <th class="px-4 py-3">ì•„íŒŒíŠ¸ëª…</th>
                            <th class="px-4 py-3 text-right">ê¸ˆì•¡(ë§Œì›)</th>
                            <th class="px-4 py-3 text-right">ë©´ì (ã¡)</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table-body">
                        <!-- Rows will be added here via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <footer class="text-center text-slate-400 text-sm mt-8 pb-8">
            <p>Â© 2026 ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ - ë°ì´í„° ì¶œì²˜: ê³µê³µë°ì´í„°í¬í„¸(êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™)</p>
        </footer>
    </div>

    <script>
        // Provided PubHTML to CSV URL Conversion
        const ORIGINAL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSy6gHRdGFOGRYr6AN_oRCJ-5IRpq9_6uNnOvZCVLK1JFFShRFf3V3vYr46Ke-zVovuz0094-izOygm/pubhtml?gid=67810494&single=true";
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSy6gHRdGFOGRYr6AN_oRCJ-5IRpq9_6uNnOvZCVLK1JFFShRFf3V3vYr46Ke-zVovuz0094-izOygm/pub?gid=67810494&single=true&output=csv";

        let myChart = null;
        let globalData = []; // ì „ì²´ ë°ì´í„°ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜ ì¶”ê°€

        async function fetchData() {
            showLoading(true);
            try {
                const response = await fetch(CSV_URL);
                const csvString = await response.text();
                
                Papa.parse(csvString, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processData(results.data);
                        showLoading(false);
                    },
                    error: function(err) {
                        console.error("CSV Parsing Error:", err);
                        showLoading(false);
                        alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            } catch (error) {
                console.error("Fetch Error:", error);
                showLoading(false);
                alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function processData(data) {
            // 1. Cleaning and Formatting
            globalData = data.filter(row => row['ê±°ë˜ì¼ì'] && row['ê±°ë˜ê¸ˆì•¡(ë§Œì›)'])
                                    .map(row => {
                                        // Handle potential string cleaning for price if necessary
                                        const price = typeof row['ê±°ë˜ê¸ˆì•¡(ë§Œì›)'] === 'string' ? 
                                                      parseInt(row['ê±°ë˜ê¸ˆì•¡(ë§Œì›)'].replace(/,/g, '')) : 
                                                      row['ê±°ë˜ê¸ˆì•¡(ë§Œì›)'];
                                        return {
                                            ...row,
                                            price: price,
                                            date: row['ê±°ë˜ì¼ì'].toString()
                                        };
                                    });

            // ë²•ì •ë™ ëª©ë¡ ì¶”ì¶œ ë° ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ì±„ìš°ê¸°
            const dongs = [...new Set(globalData.map(d => d['ë²•ì •ë™']))].filter(Boolean).sort();
            const select = document.getElementById('dong-filter');
            
            // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™” í›„ "ì „ì²´" ì¶”ê°€
            select.innerHTML = '<option value="ì „ì²´">ì „ì²´ ë™ë„¤</option>';
            
            dongs.forEach(dong => {
                const option = document.createElement('option');
                option.value = dong;
                option.textContent = dong;
                select.appendChild(option);
            });

            // ì´ˆê¸° ëŒ€ì‹œë³´ë“œ ë Œë”ë§ (ì „ì²´ ë°ì´í„°)
            applyFilter();
        }

        function applyFilter() {
            const selectedDong = document.getElementById('dong-filter').value;
            let filteredData = globalData;
            
            // ì„ íƒëœ ë™ë„¤ê°€ "ì „ì²´"ê°€ ì•„ë‹ˆë©´ í•„í„°ë§ ì ìš©
            if (selectedDong !== "ì „ì²´") {
                filteredData = globalData.filter(d => d['ë²•ì •ë™'] === selectedDong);
            }

            updateDashboard(filteredData);
        }

        function updateDashboard(data) {
            // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
            if (data.length === 0) {
                document.getElementById('stat-total').innerText = '0 ê±´';
                document.getElementById('stat-avg').innerText = '0 ë§Œì›';
                document.getElementById('stat-max').innerText = '0 ë§Œì›';
                document.getElementById('stat-min').innerText = '0 ë§Œì›';
                renderTable([]);
                renderChart([], []);
                renderTop5([]); // ì¶”ê°€ëœ TOP 5 ì´ˆê¸°í™”
                return;
            }

            // 2. Summary Stats
            const total = data.length;
            const prices = data.map(d => d.price);
            const avg = prices.reduce((a, b) => a + b, 0) / total;
            const max = Math.max(...prices);
            const min = Math.min(...prices);

            document.getElementById('stat-total').innerText = total.toLocaleString() + ' ê±´';
            document.getElementById('stat-avg').innerText = Math.round(avg).toLocaleString() + ' ë§Œì›';
            document.getElementById('stat-max').innerText = max.toLocaleString() + ' ë§Œì›';
            document.getElementById('stat-min').innerText = min.toLocaleString() + ' ë§Œì›';

            // 3. Render Table
            renderTable(data);

            // 3-1. Render Top 5
            renderTop5(data);

            // 4. Monthly Chart Data
            const monthlyData = {};
            data.forEach(d => {
                const monthKey = d.date.substring(0, 7); // "2024-01" or "202401" depending on source format
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { sum: 0, count: 0 };
                }
                monthlyData[monthKey].sum += d.price;
                monthlyData[monthKey].count += 1;
            });

            // Sort months
            const sortedMonths = Object.keys(monthlyData).sort();
            const chartLabels = sortedMonths;
            const chartValues = sortedMonths.map(m => Math.round(monthlyData[m].sum / monthlyData[m].count));

            renderChart(chartLabels, chartValues);
        }

        function renderTable(data) {
            const tbody = document.getElementById('transaction-table-body');
            tbody.innerHTML = "";

            // Sort by date descending
            const sorted = [...data].sort((a, b) => b.date.localeCompare(a.date));

            sorted.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // ì§ìˆ˜/í™€ìˆ˜ ì¤„ë¬´ëŠ¬(Zebra) ë° í˜¸ë²„(Hover) ì‹œ ì—°í•œ ì´ˆë¡ìƒ‰ ë°°ê²½ ê°•ì¡°
                const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                tr.className = `border-b ${bgClass} hover:!bg-green-100 transition duration-150`;
                
                // 5ì–µ(50,000ë§Œì›) ì´ìƒì´ë©´ ë¹¨ê°„ìƒ‰, ì•„ë‹ˆë©´ ê¸°ì¡´ ì´ˆë¡ìƒ‰ ìœ ì§€
                const priceColorClass = row.price >= 50000 ? 'text-red-500' : 'text-green-600';

                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium">${row.date}</td>
                    <td class="px-4 py-3">${row['ì•„íŒŒíŠ¸ëª…']}</td>
                    <td class="px-4 py-3 text-right font-semibold ${priceColorClass}">${row.price.toLocaleString()}</td>
                    <td class="px-4 py-3 text-right text-slate-400">${row['ì „ìš©ë©´ì (ã¡)']}ã¡</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ì¶”ê°€ëœ TOP 5 ë Œë”ë§ í•¨ìˆ˜
        function renderTop5(data) {
            const container = document.getElementById('top5-container');
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ê¸ˆì•¡ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            const sortedDesc = [...data].sort((a, b) => {
                if (b.price !== a.price) return b.price - a.price;
                // ê¸ˆì•¡ì´ ê°™ì„ ê²½ìš° ìµœì‹  ê±°ë˜ì¼ì ìš°ì„ 
                return b.date.localeCompare(a.date);
            });

            // ìƒìœ„ 5ê°œ ì¶”ì¶œ
            const top5 = sortedDesc.slice(0, 5);

            top5.forEach((row, index) => {
                const rank = index + 1;
                
                // 1~3ìœ„ ê¸ˆ, ì€, ë™ ê°•ì¡° ë° 4~5ìœ„ ê¸°ë³¸ ìƒ‰ìƒ
                let badgeColor = "bg-slate-100 text-slate-600";
                if (rank === 1) badgeColor = "bg-yellow-100 text-yellow-600 border border-yellow-300"; // ê¸ˆìƒ‰
                else if (rank === 2) badgeColor = "bg-gray-200 text-gray-500 border border-gray-400"; // ì€ìƒ‰
                else if (rank === 3) badgeColor = "bg-orange-100 text-orange-600 border border-orange-300"; // ë™ìƒ‰

                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-3 rounded-lg border border-slate-100 bg-slate-50 hover:bg-green-50 transition";
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm shadow-sm ${badgeColor}">
                            ${rank}
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm truncate w-32 md:w-48" title="${row['ì•„íŒŒíŠ¸ëª…']}">${row['ì•„íŒŒíŠ¸ëª…']}</p>
                            <p class="text-xs text-slate-500">${row['ì „ìš©ë©´ì (ã¡)']}ã¡ Â· ${row['ì¸µ']}ì¸µ</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">${row.price.toLocaleString()}ë§Œ</p>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderChart(labels, values) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í‰ê·  ê±°ë˜ê¸ˆì•¡',
                        data: values,
                        borderColor: '#16a34a', /* ë³€ê²½: green-600 */
                        backgroundColor: 'rgba(22, 163, 74, 0.1)', /* ë³€ê²½: green rgb */
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#16a34a', /* ë³€ê²½: green-600 */
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: function(value) { return value.toLocaleString() + 'ë§Œ'; }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function showLoading(isLoading) {
            const loader = document.getElementById('loading');
            if (isLoading) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        // Initialize on load
        window.onload = fetchData;
    </script>
</body>
</html>
