<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 동네 아파트 실거래가 대시보드</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse (CSV Parsing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .table-container { max-height: 500px; overflow-y: auto; }
        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">우리 동네 아파트 실거래가 대시보드</h1>
                <p class="text-slate-500 mt-1">최신 아파트 거래 현황을 분석하고 시각화합니다.</p>
            </div>
            <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition shadow-sm font-medium">
                데이터 새로고침
            </button>
        </header>

        <!-- Loading Overlay -->
        <div id="loading" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center hidden">
            <div class="flex flex-col items-center">
                <div class="loader mb-4"></div>
                <p class="text-slate-600 font-medium">데이터를 분석 중입니다...</p>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card p-6 border-l-4 border-blue-500">
                <p class="text-sm text-slate-500 font-medium">전체 거래 건수</p>
                <h3 id="stat-total" class="text-2xl font-bold text-slate-800 mt-1">-</h3>
            </div>
            <div class="card p-6 border-l-4 border-green-500">
                <p class="text-sm text-slate-500 font-medium">평균 거래가격</p>
                <h3 id="stat-avg" class="text-2xl font-bold text-slate-800 mt-1">-</h3>
            </div>
            <div class="card p-6 border-l-4 border-purple-500">
                <p class="text-sm text-slate-500 font-medium">최고 거래가격</p>
                <h3 id="stat-max" class="text-2xl font-bold text-slate-800 mt-1">-</h3>
            </div>
            <div class="card p-6 border-l-4 border-red-500">
                <p class="text-sm text-slate-500 font-medium">최저 거래가격</p>
                <h3 id="stat-min" class="text-2xl font-bold text-slate-800 mt-1">-</h3>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Chart Container -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-6">월별 평균 거래가격 추이 (만원)</h2>
                <div class="h-80 relative">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- Table Container -->
            <div class="card p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-6">최신 거래 목록</h2>
                <div class="table-container border rounded-lg">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs uppercase bg-slate-50 sticky top-0 text-slate-700 font-semibold border-b">
                            <tr>
                                <th class="px-4 py-3">거래일자</th>
                                <th class="px-4 py-3">아파트명</th>
                                <th class="px-4 py-3 text-right">금액(만원)</th>
                                <th class="px-4 py-3 text-right">면적(㎡)</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body">
                            <!-- Rows will be added here via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer class="text-center text-slate-400 text-sm mt-8 pb-8">
            <p>© 2025 아파트 실거래가 대시보드 - 데이터 출처: 공공데이터포털(구글 시트 연동)</p>
        </footer>
    </div>

    <script>
        // Provided PubHTML to CSV URL Conversion
        const ORIGINAL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSy6gHRdGFOGRYr6AN_oRCJ-5IRpq9_6uNnOvZCVLK1JFFShRFf3V3vYr46Ke-zVovuz0094-izOygm/pubhtml?gid=67810494&single=true";
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSy6gHRdGFOGRYr6AN_oRCJ-5IRpq9_6uNnOvZCVLK1JFFShRFf3V3vYr46Ke-zVovuz0094-izOygm/pub?gid=67810494&single=true&output=csv";

        let myChart = null;

        async function fetchData() {
            showLoading(true);
            try {
                const response = await fetch(CSV_URL);
                const csvString = await response.text();
                
                Papa.parse(csvString, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processData(results.data);
                        showLoading(false);
                    },
                    error: function(err) {
                        console.error("CSV Parsing Error:", err);
                        showLoading(false);
                        alert("데이터를 불러오는데 실패했습니다.");
                    }
                });
            } catch (error) {
                console.error("Fetch Error:", error);
                showLoading(false);
                alert("네트워크 오류가 발생했습니다.");
            }
        }

        function processData(data) {
            // 1. Cleaning and Formatting
            const cleanedData = data.filter(row => row['거래일자'] && row['거래금액(만원)'])
                                    .map(row => {
                                        // Handle potential string cleaning for price if necessary
                                        const price = typeof row['거래금액(만원)'] === 'string' ? 
                                                      parseInt(row['거래금액(만원)'].replace(/,/g, '')) : 
                                                      row['거래금액(만원)'];
                                        return {
                                            ...row,
                                            price: price,
                                            date: row['거래일자'].toString()
                                        };
                                    });

            // 2. Summary Stats
            const total = cleanedData.length;
            const prices = cleanedData.map(d => d.price);
            const avg = prices.reduce((a, b) => a + b, 0) / total;
            const max = Math.max(...prices);
            const min = Math.min(...prices);

            document.getElementById('stat-total').innerText = total.toLocaleString() + ' 건';
            document.getElementById('stat-avg').innerText = Math.round(avg).toLocaleString() + ' 만원';
            document.getElementById('stat-max').innerText = max.toLocaleString() + ' 만원';
            document.getElementById('stat-min').innerText = min.toLocaleString() + ' 만원';

            // 3. Render Table
            renderTable(cleanedData);

            // 4. Monthly Chart Data
            // Logic: Group by YYYY-MM
            const monthlyData = {};
            cleanedData.forEach(d => {
                const monthKey = d.date.substring(0, 7); // "2024-01" or "202401" depending on source format
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { sum: 0, count: 0 };
                }
                monthlyData[monthKey].sum += d.price;
                monthlyData[monthKey].count += 1;
            });

            // Sort months
            const sortedMonths = Object.keys(monthlyData).sort();
            const chartLabels = sortedMonths;
            const chartValues = sortedMonths.map(m => Math.round(monthlyData[m].sum / monthlyData[m].count));

            renderChart(chartLabels, chartValues);
        }

        function renderTable(data) {
            const tbody = document.getElementById('transaction-table-body');
            tbody.innerHTML = "";

            // Sort by date descending
            const sorted = [...data].sort((a, b) => b.date.localeCompare(a.date));

            sorted.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium">${row.date}</td>
                    <td class="px-4 py-3">${row['아파트명']}</td>
                    <td class="px-4 py-3 text-right font-semibold text-blue-600">${row.price.toLocaleString()}</td>
                    <td class="px-4 py-3 text-right text-slate-400">${row['전용면적(㎡)']}㎡</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderChart(labels, values) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '평균 거래금액',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#3b82f6',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: function(value) { return value.toLocaleString() + '만'; }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function showLoading(isLoading) {
            const loader = document.getElementById('loading');
            if (isLoading) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        // Initialize on load
        window.onload = fetchData;
    </script>
</body>
</html>
